<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å‹¤æ€ ç®¡ç†</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
:root {
  --bg:#f0f7ff;
  --surface:#ffffff;
  --surface2:#f5f9ff;
  --surface3:#eaf2ff;
  --border:#d0e4f7;
  --border2:#b8d4f0;
  --text:#1a3050;
  --text-sub:#6b8cad;
  --text-dim:#a0b8cc;
  --green:#16a34a;
  --green-bg:#dcfce7;
  --red:#dc2626;
  --red-bg:#fee2e2;
  --amber:#d97706;
  --amber-bg:#fef3c7;
  --blue:#2563eb;
  --blue-bg:#dbeafe;
  --radius:16px;
  --shadow:0 4px 24px rgba(37,99,235,0.10);
  --shadow-sm:0 2px 8px rgba(37,99,235,0.08);
}
body {
  font-family:'Noto Sans JP',sans-serif;
  background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 40%, #fef9ee 100%);
  background-attachment: fixed;
  color:var(--text);
  min-height:100vh;
  padding-bottom:40px;
}
body::before {
  content:'';
  position:fixed;
  inset:0;
  background:
    radial-gradient(ellipse at 10% 20%, rgba(147,210,255,0.3) 0%, transparent 50%),
    radial-gradient(ellipse at 90% 80%, rgba(255,213,128,0.2) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 50%, rgba(200,240,255,0.15) 0%, transparent 70%);
  pointer-events:none;
  z-index:0;
}

/* â”€â”€ NAV â”€â”€ */
.nav {
  position:sticky; top:0; z-index:50;
  background:rgba(255,255,255,0.85);
  backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);
  padding:0 16px;
  display:flex; gap:4px;
  overflow-x:auto;
  box-shadow:0 2px 12px rgba(37,99,235,0.08);
}
.nav::-webkit-scrollbar { display:none; }
.nav-btn {
  padding:14px 16px;
  background:none; border:none;
  color:var(--text-sub);
  font-family:'Noto Sans JP',sans-serif;
  font-size:13px; font-weight:500;
  cursor:pointer; white-space:nowrap;
  border-bottom:2px solid transparent;
  transition:all 0.2s;
}
.nav-btn.active { color:var(--blue); border-bottom-color:var(--blue); }

/* â”€â”€ PAGES â”€â”€ */
.page { display:none; padding:20px 16px; max-width:480px; margin:0 auto; }
.page.active { display:block; }

/* â”€â”€ CARD â”€â”€ */
.card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:24px 20px;
  margin-bottom:16px;
  box-shadow:var(--shadow);
  position:relative;
  z-index:1;
}

/* â”€â”€ CLOCK â”€â”€ */
.clock-wrap { text-align:center; margin-bottom:24px; }
.clock {
  font-family:'DM Mono',monospace;
  font-size:52px; font-weight:500;
  letter-spacing:-0.02em; line-height:1;
  margin-bottom:6px;
  background: linear-gradient(135deg, #1d4ed8, #0ea5e9);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.clock-date { font-size:13px; color:var(--text-sub); }
.greeting { font-size:15px; font-weight:700; color:var(--text); margin-bottom:4px; }

/* â”€â”€ LABEL â”€â”€ */
.label {
  font-size:11px; letter-spacing:0.15em;
  text-transform:uppercase; color:var(--text-sub);
  font-family:'DM Mono',monospace;
  margin-bottom:8px;
}

/* â”€â”€ SELECT â”€â”€ */
.sel-wrap { position:relative; margin-bottom:20px; }
select {
  width:100%; padding:14px 40px 14px 14px;
  background:var(--surface2); border:1.5px solid var(--border);
  border-radius:12px; color:var(--text);
  font-family:'Noto Sans JP',sans-serif; font-size:15px;
  appearance:none; cursor:pointer; outline:none;
  transition:all 0.2s;
  box-shadow:var(--shadow-sm);
}
select:focus { border-color:var(--blue); box-shadow:0 0 0 3px rgba(37,99,235,0.1); }
.sel-arrow { position:absolute; right:14px; top:50%; transform:translateY(-50%); color:var(--text-sub); pointer-events:none; }

/* â”€â”€ BUTTONS â”€â”€ */
.btn-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px; }
.btn {
  padding:20px 12px; border:none; border-radius:14px;
  font-family:'Noto Sans JP',sans-serif;
  font-size:16px; font-weight:700;
  cursor:pointer; transition:all 0.15s;
  display:flex; flex-direction:column; align-items:center; gap:6px;
}
.btn:active { transform:scale(0.96); }
.btn:disabled { opacity:0.35; cursor:not-allowed; transform:none; }
.btn-icon { font-size:24px; display:flex; align-items:center; justify-content:center; }
.btn { gap:8px; padding:22px 12px; }
.btn-green { background:linear-gradient(135deg,#16a34a,#22c55e); color:#fff; border:none; box-shadow:0 4px 16px rgba(22,163,74,0.3); }
.btn-green:hover:not(:disabled) { box-shadow:0 6px 24px rgba(22,163,74,0.45); transform:translateY(-1px); }
.btn-red { background:linear-gradient(135deg,#dc2626,#ef4444); color:#fff; border:none; box-shadow:0 4px 16px rgba(220,38,38,0.3); }
.btn-red:hover:not(:disabled) { box-shadow:0 6px 24px rgba(220,38,38,0.45); transform:translateY(-1px); }
.btn-amber { background:var(--amber-bg); color:var(--amber); border:1px solid var(--amber); }
.btn-blue { background:var(--blue-bg); color:var(--blue); border:1px solid var(--blue); }
.btn-full {
  width:100%; padding:14px; border:none; border-radius:12px;
  font-family:'Noto Sans JP',sans-serif; font-size:15px; font-weight:700;
  cursor:pointer; transition:all 0.15s; margin-top:8px;
}
.btn-full:active { transform:scale(0.98); }
.btn-full-amber { background:linear-gradient(135deg,#d97706,#f59e0b); color:#fff; box-shadow:0 3px 12px rgba(217,119,6,0.3); }
.btn-full-amber:hover { opacity:0.9; transform:translateY(-1px); }
.btn-full-blue { background:linear-gradient(135deg,#1d4ed8,#3b82f6); color:#fff; box-shadow:0 3px 12px rgba(29,78,216,0.3); }
.btn-full-blue:hover { opacity:0.9; transform:translateY(-1px); }
.btn-full-red { background:var(--red-bg); color:var(--red); border:1px solid rgba(220,38,38,0.3); }

/* â”€â”€ INPUT â”€â”€ */
input[type=text], input[type=date], textarea {
  width:100%; padding:12px 14px;
  background:var(--surface2); border:1.5px solid var(--border);
  border-radius:10px; color:var(--text);
  font-family:'Noto Sans JP',sans-serif; font-size:14px;
  outline:none; transition:all 0.2s;
  margin-bottom:12px;
  box-shadow:var(--shadow-sm);
}
input[type=text]:focus, input[type=date]:focus, textarea:focus { border-color:var(--blue); box-shadow:0 0 0 3px rgba(37,99,235,0.1); }
input[type=date]::-webkit-calendar-picker-indicator { filter:invert(0.5); }
textarea { resize:vertical; min-height:80px; }

/* â”€â”€ TAG â”€â”€ */
.tag {
  display:inline-block; padding:3px 10px;
  border-radius:20px; font-size:11px; font-weight:700;
}
.tag-pending { background:var(--amber-bg); color:var(--amber); border:1px solid var(--amber); }
.tag-approved { background:var(--green-bg); color:var(--green); border:1px solid var(--green); }
.tag-rejected { background:var(--red-bg); color:var(--red); border:1px solid var(--red); }

/* â”€â”€ LIST ITEMS â”€â”€ */
.list-item {
  background:var(--surface); border:1px solid var(--border);
  border-radius:12px; padding:14px 16px;
  margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;
  box-shadow:var(--shadow-sm);
  transition:box-shadow 0.2s;
}
.list-item:hover { box-shadow:var(--shadow); }
.list-item-left { display:flex; align-items:center; gap:12px; }
.list-item-name { font-size:14px; font-weight:500; }
.list-item-sub { font-size:12px; color:var(--text-sub); margin-top:2px; }

/* â”€â”€ EMPLOYEE ITEM â”€â”€ */
.emp-item {
  background:var(--surface2); border:1px solid var(--border);
  border-radius:12px; padding:12px 16px;
  margin-bottom:8px; display:flex; align-items:center; justify-content:space-between;
}
.emp-name { font-size:14px; font-weight:500; }
.emp-type { font-size:11px; color:var(--text-sub); margin-top:2px; }
.emp-actions { display:flex; gap:8px; }
.icon-btn {
  width:32px; height:32px; border:none; border-radius:8px;
  background:var(--surface3); color:var(--text-sub);
  cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center;
  transition:all 0.15s;
}
.icon-btn:hover { background:var(--border2); color:var(--text); }
.icon-btn.danger:hover { background:var(--red-bg); color:var(--red); }

/* â”€â”€ CALENDAR â”€â”€ */
.cal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
.cal-title { font-size:16px; font-weight:700; }
.cal-nav { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:6px 12px; color:var(--text); cursor:pointer; font-size:14px; }
.cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
.cal-day-label { text-align:center; font-size:11px; color:var(--text-sub); padding:6px 0; font-family:'DM Mono',monospace; }
.cal-day {
  aspect-ratio:1; border-radius:8px; border:1px solid transparent;
  display:flex; align-items:center; justify-content:center;
  font-size:13px; cursor:pointer; transition:all 0.15s;
  background:var(--surface2);
}
.cal-day:hover:not(.cal-day-empty):not(.cal-day-past) { border-color:var(--amber); color:var(--amber); }
.cal-day.selected { background:var(--amber); color:#000; font-weight:700; border-color:var(--amber); }
.cal-day.today { border-color:var(--blue); color:var(--blue); }
.cal-day.cal-day-empty { background:transparent; border-color:transparent; cursor:default; }
.cal-day.cal-day-past { opacity:0.3; cursor:not-allowed; }
.cal-day.approved { background:var(--green-bg); color:var(--green); border-color:var(--green); cursor:default; }

/* â”€â”€ SECTION TITLE â”€â”€ */
.section-title { font-size:14px; font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px; }

/* â”€â”€ SETUP â”€â”€ */
.setup-box {
  background:var(--amber-bg); border:1.5px dashed rgba(217,119,6,0.3);
  border-radius:12px; padding:16px; margin-top:16px;
  position:relative; z-index:1;
}
.setup-title-row { font-size:11px; letter-spacing:0.15em; text-transform:uppercase; color:var(--amber); font-family:'DM Mono',monospace; margin-bottom:10px; }
.setup-note { font-size:11px; color:var(--text-sub); line-height:1.7; margin-top:8px; }
.status-dot { display:inline-block; width:7px; height:7px; border-radius:50%; background:var(--red); margin-right:5px; vertical-align:middle; }
.status-dot.on { background:var(--green); }



/* â”€â”€ SELFIE â”€â”€ */
@keyframes pulse-border {
  0%,100% { opacity:0.6; }
  50% { opacity:1; }
}
#selfieGuide div { animation: pulse-border 2s infinite; }

/* â”€â”€ PIN â”€â”€ */
.pin-dot {
  width:14px; height:14px; border-radius:50%;
  border:2px solid var(--border2); background:transparent;
  transition:all 0.15s;
}
.pin-dot.filled { background:var(--amber); border-color:var(--amber); }
.pin-dot.error { background:var(--red); border-color:var(--red); }
.pin-key {
  padding:16px; border:1px solid var(--border2);
  border-radius:12px; background:var(--surface2); color:var(--text);
  font-family:'DM Mono',monospace; font-size:20px; font-weight:500;
  cursor:pointer; transition:all 0.1s;
}
.pin-key:active { background:var(--surface3); transform:scale(0.95); }
.pin-key-clear { color:var(--red); border-color:var(--red-bg); }
.pin-key-del { color:var(--text-sub); }

/* â”€â”€ QR â”€â”€ */
.qr-item {
  background:var(--surface2); border:1px solid var(--border);
  border-radius:12px; padding:16px; margin-bottom:12px;
}
.qr-item-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
.qr-item-name { font-size:15px; font-weight:700; }
.qr-item-type { font-size:11px; color:var(--text-sub); margin-top:2px; }
.qr-canvas-wrap { display:flex; justify-content:center; margin-bottom:12px; }
.qr-canvas-wrap canvas { border-radius:8px; }
.qr-url { font-size:10px; color:var(--text-dim); word-break:break-all; margin-bottom:10px; font-family:'DM Mono',monospace; }
.qr-btns { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.qr-btn {
  padding:10px; border:none; border-radius:8px;
  font-family:'Noto Sans JP',sans-serif; font-size:12px; font-weight:700;
  cursor:pointer; transition:all 0.15s;
}
.qr-btn-print { background:var(--surface3); color:var(--text); border:1px solid var(--border2); }
.qr-btn-copy { background:var(--amber-bg); color:var(--amber); border:1px solid var(--amber); }
.qr-btn:hover { opacity:0.85; }
.divider { height:1px; background:var(--border); margin:20px 0; }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position:fixed; bottom:28px; left:50%;
  transform:translateX(-50%) translateY(80px);
  background:#fff; border:1.5px solid var(--border);
  border-radius:14px; padding:13px 18px;
  display:flex; align-items:center; gap:10px;
  min-width:260px; max-width:340px;
  box-shadow:0 8px 32px rgba(37,99,235,0.15);
  transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
  z-index:200; white-space:nowrap;
  color:var(--text);
}
.toast.show { transform:translateX(-50%) translateY(0); }

/* â”€â”€ MODAL â”€â”€ */
.overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  z-index:100; display:none; align-items:center; justify-content:center; padding:20px;
}
.overlay.open { display:flex; }
.modal {
  background:var(--surface); border:1px solid var(--border);
  border-radius:20px; padding:24px 20px; width:100%; max-width:360px;
  box-shadow:0 20px 60px rgba(37,99,235,0.15);
}
.modal-title { font-size:16px; font-weight:700; margin-bottom:16px; }
.modal-actions { display:flex; gap:10px; margin-top:16px; }
.modal-actions .btn-full { margin-top:0; flex:1; }
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav" id="mainNav">
  <button class="nav-btn active" onclick="showPage('punch')">â± æ‰“åˆ»</button>
  <button class="nav-btn" onclick="showPage('leave')">ğŸ“ æœ‰çµ¦ç”³è«‹</button>
  <button class="nav-btn" id="navShift" onclick="showPage('shift')">ğŸ“† ã‚·ãƒ•ãƒˆç”³è«‹</button>
  <button class="nav-btn" id="navEmployees" onclick="showPage('employees')">ğŸ‘¥ ç¤¾å“¡ç®¡ç†</button>
  <button class="nav-btn" id="navQr" onclick="showPage('qr')">ğŸ”— QRã‚³ãƒ¼ãƒ‰</button>
  <button class="nav-btn" onclick="showPage('settings')">âš™ï¸ è¨­å®š</button>
</nav>

<!-- å€‹äººãƒšãƒ¼ã‚¸ç”¨ãƒãƒŠãƒ¼ -->
<div id="personalBanner" style="display:none;background:linear-gradient(90deg,#fffbeb,#fef3c7);border-bottom:2px solid #f59e0b;padding:10px 20px;text-align:center;font-size:13px;color:#92400e;font-weight:600;">
  ğŸ‘¤ <span id="bannerName"></span>ã•ã‚“ã®å°‚ç”¨ãƒšãƒ¼ã‚¸
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: æ‰“åˆ»
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="page-punch">
  <div class="card">
    <div class="clock-wrap">
      <div class="greeting" id="greeting">ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™â˜€ï¸</div>
      <div class="clock" id="clock">--:--</div>
      <div class="clock-date" id="date">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    <div class="label">æ°åã‚’é¸æŠ</div>
    <div class="sel-wrap">
      <select id="punchName"><option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option></select>
      <span class="sel-arrow">â–¼</span>
    </div>
    <div class="label">æ‰“åˆ»</div>
    <div class="btn-grid">
      <button class="btn btn-green" id="btnIn" onclick="handlePunch('å‡ºå‹¤')">
        <span class="btn-icon">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 8 12 12 14 14"/>
            <line x1="16.5" y1="3.5" x2="19.5" y2="6.5" stroke-width="1.5"/>
            <line x1="7.5" y1="3.5" x2="4.5" y2="6.5" stroke-width="1.5"/>
          </svg>
        </span>
        <span style="font-size:18px;font-weight:800;letter-spacing:0.05em;">å‡ºå‹¤</span>
        <span style="font-size:11px;font-weight:400;opacity:0.8;">CLOCK IN</span>
      </button>
      <button class="btn btn-red" id="btnOut" onclick="handlePunch('é€€å‹¤')">
        <span class="btn-icon">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
        </span>
        <span style="font-size:18px;font-weight:800;letter-spacing:0.05em;">é€€å‹¤</span>
        <span style="font-size:11px;font-weight:400;opacity:0.8;">CLOCK OUT</span>
      </button>
    </div>
  </div>

  <div class="setup-box" id="gasSetupBox">
    <div class="setup-title-row">âš™ï¸ GASé€£æºè¨­å®šã€€<span id="statusDot" class="status-dot"></span><span id="statusText">æœªè¨­å®š</span></div>
    <input type="text" id="gasUrl" placeholder="Google Apps Script ã® Webã‚¢ãƒ—ãƒªURL" style="margin-bottom:8px;">
    <button class="btn-full btn-full-amber" onclick="saveGasUrl()">URLã‚’ä¿å­˜ã™ã‚‹</button>
    <div class="setup-note">â€» GASã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ç™ºè¡Œã•ã‚ŒãŸURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: æœ‰çµ¦ç”³è«‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-leave">
  <div class="card">
    <div class="section-title">ğŸ“ æœ‰çµ¦ç”³è«‹</div>
    <div class="label">ç”³è«‹è€…</div>
    <div class="sel-wrap" style="margin-bottom:16px;">
      <select id="leaveName"><option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option></select>
      <span class="sel-arrow">â–¼</span>
    </div>
    <div class="label">å–å¾—æ—¥</div>
    <input type="date" id="leaveDate">
    <div class="label">ç†ç”±ï¼ˆä»»æ„ï¼‰</div>
    <textarea id="leaveReason" placeholder="ç§ç”¨ã®ãŸã‚ã€€ãªã©"></textarea>
    <button class="btn-full btn-full-amber" onclick="submitLeave()">ç”³è«‹ã™ã‚‹</button>
  </div>

  <div class="card">
    <div class="section-title">ğŸ“‹ ç”³è«‹å±¥æ­´</div>
    <div id="leaveHistory"><div style="color:var(--text-sub);font-size:13px;">ç”³è«‹ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: ã‚·ãƒ•ãƒˆç”³è«‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-shift">
  <div class="card">
    <div class="section-title">ğŸ“† ã‚·ãƒ•ãƒˆå¸Œæœ›ç”³è«‹</div>
    <div class="label">ç”³è«‹è€…</div>
    <div class="sel-wrap" style="margin-bottom:16px;">
      <select id="shiftName"><option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option></select>
      <span class="sel-arrow">â–¼</span>
    </div>

    <div class="cal-header">
      <button class="cal-nav" onclick="changeMonth(-1)">â—€</button>
      <div class="cal-title" id="calTitle"></div>
      <button class="cal-nav" onclick="changeMonth(1)">â–¶</button>
    </div>

    <div class="cal-grid" id="calDayLabels"></div>
    <div class="cal-grid" id="calGrid" style="margin-top:4px;"></div>

    <div style="margin-top:14px;font-size:12px;color:var(--text-sub);">
      ğŸŸ¡ é¸æŠä¸­ã€€ğŸŸ¢ ç”³è«‹æ¸ˆã¿
    </div>
    <button class="btn-full btn-full-blue" style="margin-top:16px;" onclick="submitShift()">å¸Œæœ›ã‚’é€ä¿¡ã™ã‚‹</button>
  </div>

  <div class="card">
    <div class="section-title">ğŸ“‹ ç”³è«‹å±¥æ­´</div>
    <div id="shiftHistory"><div style="color:var(--text-sub);font-size:13px;">ç”³è«‹ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: ç¤¾å“¡ç®¡ç†
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-employees">
  <div class="card">
    <div class="section-title">â• ç¤¾å“¡ã‚’è¿½åŠ </div>
    <div class="label">æ°å</div>
    <input type="text" id="newEmpName" placeholder="ä¾‹ï¼šç”°ä¸­ å¤ªéƒ">
    <div class="label">é›‡ç”¨åŒºåˆ†</div>
    <div class="sel-wrap" style="margin-bottom:12px;">
      <select id="newEmpType">
        <option value="æ­£ç¤¾å“¡">æ­£ç¤¾å“¡</option>
        <option value="ãƒ‘ãƒ¼ãƒˆ">ãƒ‘ãƒ¼ãƒˆ</option>
      </select>
      <span class="sel-arrow">â–¼</span>
    </div>
    <div class="label">ãƒãƒ¼ãƒ </div>
    <div class="sel-wrap" style="margin-bottom:12px;">
      <select id="newEmpTeam">
        <option value="å–¶æ¥­">å–¶æ¥­ï¼ˆã‚¹ãƒãƒ›ï¼‰</option>
        <option value="ã‚ªãƒ•ã‚£ã‚¹">ã‚ªãƒ•ã‚£ã‚¹ï¼ˆiPadï¼‰</option>
      </select>
      <span class="sel-arrow">â–¼</span>
    </div>
    <button class="btn-full btn-full-amber" onclick="addEmployee()">è¿½åŠ ã™ã‚‹</button>
  </div>

  <div class="card">
    <div class="section-title">ğŸ‘¥ ç¤¾å“¡ä¸€è¦§</div>
    <div id="employeeList"></div>
  </div>

  <div class="card" id="pinSettingsCard">
    <div class="section-title">ğŸ” PINã‚³ãƒ¼ãƒ‰ç®¡ç†ï¼ˆiPadãƒãƒ¼ãƒ ç”¨ï¼‰</div>
    <div style="font-size:13px;color:var(--text-sub);margin-bottom:14px;line-height:1.7;">
      iPadãƒãƒ¼ãƒ ã®ç¤¾å“¡ã«PINã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã™ã€‚æ‰“åˆ»æ™‚ã«PINã®å…¥åŠ›ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
    </div>
    <div id="pinSettingsList"></div>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: QRã‚³ãƒ¼ãƒ‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-qr">
  <div class="card">
    <div class="section-title">ğŸ”— å€‹äººå°‚ç”¨URLã¨QRã‚³ãƒ¼ãƒ‰</div>
    <div style="font-size:13px;color:var(--text-sub);margin-bottom:16px;line-height:1.7;">
      å„ç¤¾å“¡ã®å°‚ç”¨URLã‚’ç™ºè¡Œã—ã¾ã™ã€‚ã“ã®URLã‚’é–‹ãã¨è‡ªå‹•çš„ã«æœ¬äººã®åå‰ãŒè¨­å®šã•ã‚Œã€ä»–ã®äººã‚’é¸æŠã§ããªããªã‚Šã¾ã™ã€‚
    </div>
    <div id="qrList"></div>
  </div>
  <div class="card">
    <div class="section-title">ğŸ“‹ é…å¸ƒæ–¹æ³•</div>
    <div style="font-size:13px;color:var(--text-sub);line-height:1.8;">
      <b style="color:var(--text);">â‘  QRã‚³ãƒ¼ãƒ‰ã‚’å°åˆ·</b><br>
      å„ç¤¾å“¡ã®QRã‚³ãƒ¼ãƒ‰ã‚’å°åˆ·ã—ã¦æ¸¡ã™ã‹ã€ãƒ‡ã‚¹ã‚¯ã«è²¼ã‚‹ã€‚<br><br>
      <b style="color:var(--text);">â‘¡ Slackã§URLã‚’é€ã‚‹</b><br>
      ã€ŒURLã‚’ã‚³ãƒ”ãƒ¼ã€ã—ã¦Slackã®DMã§é€ã‚Šã€ã‚¹ãƒãƒ›ã®ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚‚ã‚‰ã†ã€‚<br><br>
      <b style="color:var(--text);">â‘¢ ãƒ›ãƒ¼ãƒ ç”»é¢ã¸ã®è¿½åŠ æ–¹æ³•ï¼ˆç¤¾å“¡ã«æ¡ˆå†…ï¼‰</b><br>
      iPhoneã®å ´åˆï¼šSafariã§é–‹ãâ†’å…±æœ‰ãƒœã‚¿ãƒ³â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€<br>
      Androidã®å ´åˆï¼šChromeã§é–‹ãâ†’ãƒ¡ãƒ‹ãƒ¥ãƒ¼â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: è¨­å®š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-settings">
  <div class="card">
    <div class="section-title">âš™ï¸ GAS URLè¨­å®š</div>
    <div class="label">Webã‚¢ãƒ—ãƒªURL</div>
    <input type="text" id="gasUrlSettings" placeholder="https://script.google.com/macros/s/...">
    <button class="btn-full btn-full-amber" onclick="saveGasUrlSettings()">ä¿å­˜ã™ã‚‹</button>
  </div>

  <div class="card">
    <div class="section-title" style="color:var(--red);">ğŸ—‘ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
    <div style="font-size:13px;color:var(--text-sub);margin-bottom:12px;">ç”³è«‹å±¥æ­´ãƒ»ç¤¾å“¡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚æ‰“åˆ»ãƒ­ã‚°ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ®‹ã‚Šã¾ã™ã€‚</div>
    <button class="btn-full btn-full-red" onclick="confirmReset()">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<!-- â”€â”€ MODAL: ç¤¾å“¡ç·¨é›† â”€â”€ -->
<div class="overlay" id="editOverlay">
  <div class="modal">
    <div class="modal-title">ç¤¾å“¡æƒ…å ±ã‚’ç·¨é›†</div>
    <div class="label">æ°å</div>
    <input type="text" id="editEmpName">
    <div class="label">é›‡ç”¨åŒºåˆ†</div>
    <div class="sel-wrap">
      <select id="editEmpType">
        <option value="æ­£ç¤¾å“¡">æ­£ç¤¾å“¡</option>
        <option value="ãƒ‘ãƒ¼ãƒˆ">ãƒ‘ãƒ¼ãƒˆ</option>
      </select>
      <span class="sel-arrow">â–¼</span>
    </div>
    <div class="modal-actions">
      <button class="btn-full" style="background:var(--surface3);color:var(--text);border:1px solid var(--border);" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-full btn-full-amber" onclick="saveEdit()">ä¿å­˜</button>
    </div>
  </div>
</div>


<!-- â”€â”€ MODAL: PINèªè¨¼ â”€â”€ -->
<div class="overlay" id="pinOverlay">
  <div class="modal" style="max-width:300px;text-align:center;">
    <div style="font-size:32px;margin-bottom:8px;">ğŸ”</div>
    <div class="modal-title" style="text-align:center;" id="pinModalName">PINã‚’å…¥åŠ›</div>
    <div style="font-size:13px;color:var(--text-sub);margin-bottom:20px;">4æ¡ã®PINã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    <div id="pinDots" style="display:flex;justify-content:center;gap:12px;margin-bottom:20px;">
      <div class="pin-dot"></div><div class="pin-dot"></div>
      <div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px;">
      <button class="pin-key" onclick="pinInput('1')">1</button>
      <button class="pin-key" onclick="pinInput('2')">2</button>
      <button class="pin-key" onclick="pinInput('3')">3</button>
      <button class="pin-key" onclick="pinInput('4')">4</button>
      <button class="pin-key" onclick="pinInput('5')">5</button>
      <button class="pin-key" onclick="pinInput('6')">6</button>
      <button class="pin-key" onclick="pinInput('7')">7</button>
      <button class="pin-key" onclick="pinInput('8')">8</button>
      <button class="pin-key" onclick="pinInput('9')">9</button>
      <button class="pin-key pin-key-clear" onclick="pinClear()">âœ•</button>
      <button class="pin-key" onclick="pinInput('0')">0</button>
      <button class="pin-key pin-key-del" onclick="pinDelete()">âŒ«</button>
    </div>
    <button class="btn-full" style="background:var(--surface3);color:var(--text);border:1px solid var(--border);margin-top:4px;" onclick="closePinModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>


<!-- â”€â”€ MODAL: ã‚»ãƒ«ãƒ•ã‚£ãƒ¼æ’®å½± â”€â”€ -->
<div class="overlay" id="selfieOverlay">
  <div class="modal" style="max-width:340px;">
    <div class="modal-title" style="text-align:center;" id="selfieModalTitle">ğŸ“¸ ã‚»ãƒ«ãƒ•ã‚£ãƒ¼æ’®å½±</div>
    <div style="font-size:13px;color:var(--text-sub);text-align:center;margin-bottom:14px;" id="selfieModalSub">ã‚«ãƒ¡ãƒ©ã«é¡”ã‚’å‘ã‘ã¦æ’®å½±ã—ã¦ãã ã•ã„</div>

    <!-- ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <div style="position:relative;border-radius:12px;overflow:hidden;background:#000;margin-bottom:12px;aspect-ratio:4/3;">
      <video id="selfieVideo" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover;transform:scaleX(-1);"></video>
      <canvas id="selfieCanvas" style="display:none;"></canvas>
      <img id="selfiePreview" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:12px;" />
      <!-- ã‚¬ã‚¤ãƒ‰æ  -->
      <div id="selfieGuide" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;">
        <div style="width:120px;height:150px;border:2px dashed rgba(245,158,11,0.6);border-radius:60px;"></div>
      </div>
    </div>

    <div id="selfieBtns">
      <button class="btn-full btn-full-amber" onclick="takeSelfie()" id="btnShoot">ğŸ“¸ æ’®å½±ã™ã‚‹</button>
      <button class="btn-full" style="background:var(--surface3);color:var(--text);border:1px solid var(--border);margin-top:8px;" onclick="closeSelfieModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
    <div id="selfieConfirmBtns" style="display:none;">
      <button class="btn-full btn-full-blue" onclick="confirmSelfie()">âœ… ã“ã®å†™çœŸã§æ‰“åˆ»ã™ã‚‹</button>
      <button class="btn-full" style="background:var(--surface3);color:var(--text);border:1px solid var(--border);margin-top:8px;" onclick="retakeSelfie()">ğŸ”„ æ’®ã‚Šç›´ã™</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <span id="toastIcon">âœ…</span>
  <span id="toastText" style="font-size:13px;"></span>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getData(key, def) {
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e) { return def; }
}
function setData(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

// ç¤¾å“¡ãƒ‡ãƒ¼ã‚¿ã¯å¸¸ã«ã“ã®ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ï¼ˆç«¯æœ«é–“ã§å…±é€šï¼‰
const DEFAULT_EMPLOYEES = [
  {id:1,  name:'ç‰›è†“',      type:'æ­£ç¤¾å“¡', team:'å–¶æ¥­',    device:'smartphone'},
  {id:2,  name:'é½‹è—¤',      type:'æ­£ç¤¾å“¡', team:'å–¶æ¥­',    device:'smartphone'},
  {id:3,  name:'å—å²¡',      type:'æ­£ç¤¾å“¡', team:'å–¶æ¥­',    device:'smartphone'},
  {id:4,  name:'éˆ´æœ¨ç”±åŠ ',  type:'ãƒ‘ãƒ¼ãƒˆ', team:'å–¶æ¥­',    device:'smartphone'},
  {id:5,  name:'ä¼Šè—¤',      type:'æ­£ç¤¾å“¡', team:'ã‚ªãƒ•ã‚£ã‚¹', device:'tablet'},
  {id:6,  name:'ç”Ÿå¤©ç›®',    type:'æ­£ç¤¾å“¡', team:'ã‚ªãƒ•ã‚£ã‚¹', device:'tablet'},
  {id:7,  name:'é‡‘æ£®',      type:'æ­£ç¤¾å“¡', team:'ã‚ªãƒ•ã‚£ã‚¹', device:'tablet'},
  {id:8,  name:'è¥¿å²¡',      type:'æ­£ç¤¾å“¡', team:'ã‚ªãƒ•ã‚£ã‚¹', device:'tablet'},
  {id:9,  name:'éˆ´æœ¨ã‚ã‹ã­',type:'ãƒ‘ãƒ¼ãƒˆ', team:'ã‚ªãƒ•ã‚£ã‚¹', device:'tablet'},
  {id:10, name:'éˆ´æœ¨ç¾å’²',  type:'ãƒ‘ãƒ¼ãƒˆ', team:'ã‚ªãƒ•ã‚£ã‚¹', device:'tablet'},
  {id:11, name:'ç”°å£',      type:'æ­£ç¤¾å“¡', team:'å–¶æ¥­',    device:'smartphone'},
  {id:12, name:'ä¸‰ä¸Š',      type:'æ­£ç¤¾å“¡', team:'åŠ å·¥å®¤',  device:'tablet'},
];
let employees = getData('employees', null);
if (!employees || employees.length === 0) {
  employees = JSON.parse(JSON.stringify(DEFAULT_EMPLOYEES));
  setData('employees', employees);
}
let leaveHistory = getData('leaveHistory', []);
let shiftHistory = getData('shiftHistory', []);
let editingId = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateClock() {
  const now = new Date();
  const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const h = now.getHours();
  document.getElementById('clock').textContent =
    now.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  document.getElementById('date').textContent =
    now.getFullYear()+'å¹´'+(now.getMonth()+1)+'æœˆ'+now.getDate()+'æ—¥ï¼ˆ'+days[now.getDay()]+'ï¼‰';
  const greetEl = document.getElementById('greeting');
  if (greetEl) {
    if (h < 10) greetEl.textContent = 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ â˜€ï¸';
    else if (h < 14) greetEl.textContent = 'ãŠç–²ã‚Œæ§˜ã§ã™ ğŸŒ¤ï¸';
    else if (h < 18) greetEl.textContent = 'ã‚‚ã†ã²ã¨è¸ã‚“å¼µã‚Šï¼ ğŸ’ª';
    else greetEl.textContent = 'ãŠç–²ã‚Œæ§˜ã§ã—ãŸ ğŸŒ™';
  }
}
setInterval(updateClock, 1000);
updateClock();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGE NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  event.target.classList.add('active');
  if (id === 'employees') { renderEmployees(); renderPinSettingsList(); }
  if (id === 'leave') renderLeaveHistory();
  if (id === 'shift') {
    renderShiftHistory();
    checkShiftAccess();
  }
  if (id === 'qr') renderQrList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMPLOYEE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshSelects() {
  ['punchName','leaveName','shiftName'].forEach(id => {
    const sel = document.getElementById(id);
    const cur = sel.value;
    sel.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
    employees.forEach(e => {
      const o = document.createElement('option');
      o.value = e.name; o.textContent = e.name + 'ï¼ˆ'+e.type+'ï¼‰';
      sel.appendChild(o);
    });
    sel.value = cur;
  });
}

function renderEmployees() {
  const el = document.getElementById('employeeList');
  if (!employees.length) { el.innerHTML = '<div style="color:var(--text-sub);font-size:13px;">ç¤¾å“¡ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>'; return; }
  el.innerHTML = employees.map(e => {
    const teamBadge = e.device === 'smartphone'
      ? '<span style="font-size:10px;background:#0d2818;color:#22c55e;border:1px solid #22c55e;border-radius:4px;padding:2px 6px;margin-left:6px;">ğŸ“±å–¶æ¥­</span>'
      : '<span style="font-size:10px;background:#0d1a2e;color:#3b82f6;border:1px solid #3b82f6;border-radius:4px;padding:2px 6px;margin-left:6px;">ğŸ“²iPad</span>';
    return `
    <div class="emp-item">
      <div>
        <div class="emp-name">${e.name} ${teamBadge}</div>
        <div class="emp-type">${e.type}</div>
      </div>
      <div class="emp-actions">
        <button class="icon-btn" onclick="openEdit(${e.id})">âœï¸</button>
        <button class="icon-btn danger" onclick="deleteEmployee(${e.id})">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}

function addEmployee() {
  const name = document.getElementById('newEmpName').value.trim();
  const type = document.getElementById('newEmpType').value;
  const team = document.getElementById('newEmpTeam').value;
  const device = team === 'å–¶æ¥­' ? 'smartphone' : 'tablet';
  if (!name) { showToast('âš ï¸','æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (employees.find(e => e.name === name)) { showToast('âš ï¸','åŒã˜åå‰ã®ç¤¾å“¡ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™'); return; }
  const id = Date.now();
  employees.push({id, name, type, team, device});
  setData('employees', employees);
  document.getElementById('newEmpName').value = '';
  renderEmployees();
  refreshSelects();
  showToast('âœ…', name+'ã•ã‚“ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}

function deleteEmployee(id) {
  const emp = employees.find(e => e.id === id);
  if (!confirm(emp.name+'ã•ã‚“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  employees = employees.filter(e => e.id !== id);
  setData('employees', employees);
  renderEmployees();
  refreshSelects();
  showToast('ğŸ—‘', 'å‰Šé™¤ã—ã¾ã—ãŸ');
}

function openEdit(id) {
  editingId = id;
  const emp = employees.find(e => e.id === id);
  document.getElementById('editEmpName').value = emp.name;
  document.getElementById('editEmpType').value = emp.type;
  document.getElementById('editOverlay').classList.add('open');
}

function closeModal() {
  document.getElementById('editOverlay').classList.remove('open');
  editingId = null;
}

function saveEdit() {
  const name = document.getElementById('editEmpName').value.trim();
  const type = document.getElementById('editEmpType').value;
  if (!name) { showToast('âš ï¸','æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const emp = employees.find(e => e.id === editingId);
  emp.name = name; emp.type = type;
  setData('employees', employees);
  closeModal();
  renderEmployees();
  refreshSelects();
  showToast('âœ…','æ›´æ–°ã—ã¾ã—ãŸ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PUNCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function handlePunch(type) {
  const name = document.getElementById('punchName').value;
  if (!name) { showToast('âš ï¸','æ°åã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const emp = employees.find(e => e.name === name);
  // iPadãƒãƒ¼ãƒ ã¯ã‚»ãƒ«ãƒ•ã‚£ãƒ¼æ’®å½±
  if (emp && emp.device === 'tablet' && !personalUser) {
    openSelfieModal(name, type);
    return;
  }
  executePunch(name, type);
}

async function executePunch(name, type) {
  const gasUrl = (localStorage.getItem('gasUrl') || 'https://script.google.com/macros/s/AKfycbwqEj4yxokyOSme92A4DrpiAin_zcITtKG9GimtMlES3sbCjf7ilaZSrXLFvvH3oiiU5A/exec');
  if (!gasUrl) { showToast('âš ï¸','GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
  document.getElementById('btnIn').disabled = true;
  document.getElementById('btnOut').disabled = true;
  const now = new Date();
  const timeStr = now.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'});
  try {
    await fetch(gasUrl+'?action=punch&name='+encodeURIComponent(name)+'&type='+encodeURIComponent(type)+'&timestamp='+now.toISOString(), {method:'GET',mode:'no-cors'});
    showToast('âœ…', name+'ã•ã‚“ã®'+type+'ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼ˆ'+timeStr+'ï¼‰');
  } catch(e) {
    showToast('âŒ','é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
  } finally {
    setTimeout(() => {
      document.getElementById('btnIn').disabled = false;
      document.getElementById('btnOut').disabled = false;
    }, 2000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function submitLeave() {
  const name = document.getElementById('leaveName').value;
  const date = document.getElementById('leaveDate').value;
  const reason = document.getElementById('leaveReason').value.trim();
  if (!name) { showToast('âš ï¸','ç”³è«‹è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  if (!date) { showToast('âš ï¸','å–å¾—æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

  const record = { id:Date.now(), name, date, reason, status:'pending', createdAt: new Date().toISOString() };
  leaveHistory.unshift(record);
  setData('leaveHistory', leaveHistory);

  const gasUrl = (localStorage.getItem('gasUrl') || 'https://script.google.com/macros/s/AKfycbwqEj4yxokyOSme92A4DrpiAin_zcITtKG9GimtMlES3sbCjf7ilaZSrXLFvvH3oiiU5A/exec');
  if (gasUrl) {
    fetch(gasUrl+'?action=leave&name='+encodeURIComponent(name)+'&date='+encodeURIComponent(date)+'&reason='+encodeURIComponent(reason||'ãªã—'), {method:'GET',mode:'no-cors'}).catch(()=>{});
  }

  document.getElementById('leaveName').value = '';
  document.getElementById('leaveDate').value = '';
  document.getElementById('leaveReason').value = '';
  renderLeaveHistory();
  showToast('ğŸ“', 'æœ‰çµ¦ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
}

function renderLeaveHistory() {
  const el = document.getElementById('leaveHistory');
  if (!leaveHistory.length) { el.innerHTML = '<div style="color:var(--text-sub);font-size:13px;">ç”³è«‹ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  el.innerHTML = leaveHistory.map(r => `
    <div class="list-item">
      <div class="list-item-left">
        <div>
          <div class="list-item-name">${r.name}</div>
          <div class="list-item-sub">${r.date}ã€€${r.reason || ''}</div>
        </div>
      </div>
      <span class="tag tag-${r.status}">${r.status==='pending'?'å¯©æŸ»ä¸­':r.status==='approved'?'æ‰¿èª':'å´ä¸‹'}</span>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHIFT CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let calYear, calMonth, selectedDates = new Set();

function initCalendar() {
  const now = new Date();
  calYear = now.getFullYear();
  calMonth = now.getMonth();
  renderCalendar();
}

function changeMonth(dir) {
  calMonth += dir;
  if (calMonth > 11) { calMonth = 0; calYear++; }
  if (calMonth < 0) { calMonth = 11; calYear--; }
  renderCalendar();
}

function renderCalendar() {
  const months = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
  document.getElementById('calTitle').textContent = calYear+'å¹´ '+months[calMonth];

  const labelsEl = document.getElementById('calDayLabels');
  const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  labelsEl.innerHTML = days.map(d => `<div class="cal-day-label">${d}</div>`).join('');

  const grid = document.getElementById('calGrid');
  const firstDay = new Date(calYear, calMonth, 1).getDay();
  const lastDate = new Date(calYear, calMonth+1, 0).getDate();
  const today = new Date(); today.setHours(0,0,0,0);

  let html = '';
  for (let i=0; i<firstDay; i++) html += '<div class="cal-day cal-day-empty"></div>';

  // æ‰¿èªæ¸ˆã¿ã‚·ãƒ•ãƒˆã‚’å–å¾—
  const approvedDates = new Set();
  shiftHistory.filter(s=>s.status==='approved').forEach(s => s.dates.forEach(d=>approvedDates.add(d)));

  for (let d=1; d<=lastDate; d++) {
    const dateStr = calYear+'-'+String(calMonth+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    const thisDate = new Date(calYear, calMonth, d);
    const isPast = thisDate < today;
    const isToday = thisDate.getTime() === today.getTime();
    const isSelected = selectedDates.has(dateStr);
    const isApproved = approvedDates.has(dateStr);

    let cls = 'cal-day';
    if (isPast) cls += ' cal-day-past';
    else if (isApproved) cls += ' approved';
    else if (isSelected) cls += ' selected';
    else if (isToday) cls += ' today';

    const clickable = !isPast && !isApproved ? `onclick="toggleDate('${dateStr}')"` : '';
    html += `<div class="${cls}" ${clickable}>${d}</div>`;
  }
  grid.innerHTML = html;
}

function toggleDate(dateStr) {
  if (selectedDates.has(dateStr)) selectedDates.delete(dateStr);
  else selectedDates.add(dateStr);
  renderCalendar();
}

function submitShift() {
  const name = document.getElementById('shiftName').value;
  if (!name) { showToast('âš ï¸','ç”³è«‹è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  if (selectedDates.size === 0) { showToast('âš ï¸','å¸Œæœ›æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

  const dates = Array.from(selectedDates).sort();
  const record = { id:Date.now(), name, dates, status:'pending', createdAt: new Date().toISOString() };
  shiftHistory.unshift(record);
  setData('shiftHistory', shiftHistory);

  const gasUrl = (localStorage.getItem('gasUrl') || 'https://script.google.com/macros/s/AKfycbwqEj4yxokyOSme92A4DrpiAin_zcITtKG9GimtMlES3sbCjf7ilaZSrXLFvvH3oiiU5A/exec');
  if (gasUrl) {
    fetch(gasUrl+'?action=shift&name='+encodeURIComponent(name)+'&dates='+encodeURIComponent(dates.join(',')), {method:'GET',mode:'no-cors'}).catch(()=>{});
  }

  selectedDates.clear();
  renderCalendar();
  renderShiftHistory();
  showToast('ğŸ“†', dates.length+'æ—¥åˆ†ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
}

function checkShiftAccess() {
  // å€‹äººãƒšãƒ¼ã‚¸ã®å ´åˆã€ãƒ‘ãƒ¼ãƒˆä»¥å¤–ã¯ãƒ–ãƒ­ãƒƒã‚¯
  if (!personalUser) return; // ç®¡ç†è€…ç”»é¢ã§ã¯å…¨å“¡è¡¨ç¤º
  const emp = employees.find(e => e.name === personalUser);
  if (emp && emp.type !== 'ãƒ‘ãƒ¼ãƒˆ') {
    document.getElementById('page-shift').innerHTML =
      '<div style="padding:40px 20px;text-align:center;color:var(--text-sub);">' +
      '<div style="font-size:40px;margin-bottom:16px;">ğŸš«</div>' +
      '<div style="font-size:15px;font-weight:700;color:var(--text);">ã‚·ãƒ•ãƒˆç”³è«‹ã¯å¯¾è±¡å¤–ã§ã™</div>' +
      '<div style="font-size:13px;margin-top:8px;">ãƒ‘ãƒ¼ãƒˆç¤¾å“¡ã®ã¿åˆ©ç”¨ã§ãã¾ã™</div>' +
      '</div>';
  }
}

function renderShiftHistory() {
  const el = document.getElementById('shiftHistory');
  if (!shiftHistory.length) { el.innerHTML = '<div style="color:var(--text-sub);font-size:13px;">ç”³è«‹ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  el.innerHTML = shiftHistory.map(r => `
    <div class="list-item">
      <div class="list-item-left">
        <div>
          <div class="list-item-name">${r.name}</div>
          <div class="list-item-sub">${r.dates.length}æ—¥é¸æŠã€€${r.dates[0]}ã€œ</div>
        </div>
      </div>
      <span class="tag tag-${r.status}">${r.status==='pending'?'å¯©æŸ»ä¸­':r.status==='approved'?'æ‰¿èª':'å´ä¸‹'}</span>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAS URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadGasUrl() {
  localStorage.setItem('gasUrl', 'https://script.google.com/macros/s/AKfycbxmukcO3PUqEmJdi_t2zgyvEkuGUSF3s_8AR937BeP2yH91AdsAF2LV0Yw_AenQKz7Zbw/exec');
  const saved = (localStorage.getItem('gasUrl') || 'https://script.google.com/macros/s/AKfycbwqEj4yxokyOSme92A4DrpiAin_zcITtKG9GimtMlES3sbCjf7ilaZSrXLFvvH3oiiU5A/exec');
  if (saved) {
    document.getElementById('gasUrl').value = saved;
    document.getElementById('gasUrlSettings').value = saved;
    document.getElementById('statusDot').classList.add('on');
    document.getElementById('statusText').textContent = 'è¨­å®šæ¸ˆã¿';
  }
}

function saveGasUrl() {
  const url = document.getElementById('gasUrl').value.trim();
  if (!url || !url.startsWith('https://')) { showToast('âš ï¸','æ­£ã—ã„URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  localStorage.setItem('gasUrl', url);
  document.getElementById('gasUrlSettings').value = url;
  document.getElementById('statusDot').classList.add('on');
  document.getElementById('statusText').textContent = 'è¨­å®šæ¸ˆã¿';
  showToast('âœ…','GAS URLã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

function saveGasUrlSettings() {
  const url = document.getElementById('gasUrlSettings').value.trim();
  if (!url || !url.startsWith('https://')) { showToast('âš ï¸','æ­£ã—ã„URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  localStorage.setItem('gasUrl', url);
  document.getElementById('gasUrl').value = url;
  document.getElementById('statusDot').classList.add('on');
  document.getElementById('statusText').textContent = 'è¨­å®šæ¸ˆã¿';
  showToast('âœ…','GAS URLã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

function confirmReset() {
  if (!confirm('ç”³è«‹å±¥æ­´ãƒ»ç¤¾å“¡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
  localStorage.removeItem('leaveHistory');
  localStorage.removeItem('shiftHistory');
  leaveHistory = [];
  shiftHistory = [];
  setData('employees', employees);
  showToast('ğŸ—‘','ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SELFIE AUTHENTICATION (iPadãƒãƒ¼ãƒ )
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selfieStream = null;
let selfieCapture = null;
let selfiePendingAction = null;

async function openSelfieModal(name, punchType) {
  selfiePendingAction = { name, punchType };
  document.getElementById('selfieModalTitle').textContent = name + 'ã•ã‚“ã€€' + (punchType === 'å‡ºå‹¤' ? 'ğŸŸ¢ å‡ºå‹¤' : 'ğŸ”´ é€€å‹¤');
  document.getElementById('selfiePreview').style.display = 'none';
  document.getElementById('selfieVideo').style.display = 'block';
  document.getElementById('selfieGuide').style.display = 'flex';
  document.getElementById('selfieBtns').style.display = 'block';
  document.getElementById('selfieConfirmBtns').style.display = 'none';
  selfieCapture = null;

  document.getElementById('selfieOverlay').classList.add('open');

  try {
    selfieStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
      audio: false
    });
    document.getElementById('selfieVideo').srcObject = selfieStream;
  } catch(e) {
    showToast('âš ï¸', 'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“');
    closeSelfieModal();
  }
}

function takeSelfie() {
  const video = document.getElementById('selfieVideo');
  const canvas = document.getElementById('selfieCanvas');
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
  const ctx = canvas.getContext('2d');
  // ãƒŸãƒ©ãƒ¼åè»¢ã—ã¦è‡ªç„¶ãªè¦‹ãŸç›®ã«
  ctx.translate(canvas.width, 0);
  ctx.scale(-1, 1);
  ctx.drawImage(video, 0, 0);

  selfieCapture = canvas.toDataURL('image/jpeg', 0.7);

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
  const preview = document.getElementById('selfiePreview');
  preview.src = selfieCapture;
  preview.style.display = 'block';
  document.getElementById('selfieVideo').style.display = 'none';
  document.getElementById('selfieGuide').style.display = 'none';
  document.getElementById('selfieBtns').style.display = 'none';
  document.getElementById('selfieConfirmBtns').style.display = 'block';
}

function retakeSelfie() {
  selfieCapture = null;
  document.getElementById('selfiePreview').style.display = 'none';
  document.getElementById('selfieVideo').style.display = 'block';
  document.getElementById('selfieGuide').style.display = 'flex';
  document.getElementById('selfieBtns').style.display = 'block';
  document.getElementById('selfieConfirmBtns').style.display = 'none';
}

async function confirmSelfie() {
  if (!selfieCapture || !selfiePendingAction) return;
  const { name, punchType } = selfiePendingAction;

  // å†™çœŸã‚’GASã«é€ä¿¡ã—ã¦æ‰“åˆ»
  closeSelfieModal();
  await executePunchWithPhoto(name, punchType, selfieCapture);
}

function closeSelfieModal() {
  if (selfieStream) {
    selfieStream.getTracks().forEach(t => t.stop());
    selfieStream = null;
  }
  document.getElementById('selfieOverlay').classList.remove('open');
  selfiePendingAction = null;
  selfieCapture = null;
}

async function executePunchWithPhoto(name, type, photoData) {
  // å†™çœŸã¯ã‚¢ãƒ—ãƒªå†…ç¢ºèªã®ã¿ï¼ˆé€ä¿¡ã—ãªã„ï¼‰
  // é€šå¸¸ã®æ‰“åˆ»ã¨ã—ã¦GASã«è¨˜éŒ²
  await executePunch(name, type);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIN AUTHENTICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pins = getData('pins', {});
let pinBuffer = '';
let pinPendingAction = null; // {type, name}

function savePins() { localStorage.setItem('pins', JSON.stringify(pins)); }

function renderPinSettingsList() {
  const el = document.getElementById('pinSettingsList');
  const tabletEmps = employees.filter(e => e.device === 'tablet');
  if (!tabletEmps.length) { el.innerHTML = '<div style="color:var(--text-sub);font-size:13px;">iPadãƒãƒ¼ãƒ ã®ç¤¾å“¡ãŒã„ã¾ã›ã‚“</div>'; return; }
  el.innerHTML = tabletEmps.map(e => {
    const hasPin = !!pins[e.name];
    return `
    <div class="list-item">
      <div>
        <div class="list-item-name">${e.name}</div>
        <div class="list-item-sub">${hasPin ? 'PINè¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š'}</div>
      </div>
      <button class="qr-btn ${hasPin ? 'qr-btn-print' : 'qr-btn-copy'}" style="padding:8px 14px;font-size:12px;" onclick="promptSetPin('${e.name}')">
        ${hasPin ? 'å¤‰æ›´' : 'PINã‚’è¨­å®š'}
      </button>
    </div>`;
  }).join('');
}

function promptSetPin(name) {
  const pin = prompt(name + 'ã•ã‚“ã®æ–°ã—ã„PINï¼ˆ4æ¡ã®æ•°å­—ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
  if (!pin) return;
  if (!/^[0-9]{4}$/.test(pin)) { showToast('âš ï¸', '4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  pins[name] = pin;
  savePins();
  renderPinSettingsList();
  showToast('ğŸ”', name + 'ã•ã‚“ã®PINã‚’è¨­å®šã—ã¾ã—ãŸ');
}

// PINå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«
function openPinModal(name, punchType) {
  pinBuffer = '';
  pinPendingAction = { name, punchType };
  document.getElementById('pinModalName').textContent = name + 'ã•ã‚“ã®PIN';
  updatePinDots();
  document.getElementById('pinOverlay').classList.add('open');
}

function closePinModal() {
  document.getElementById('pinOverlay').classList.remove('open');
  pinBuffer = '';
  pinPendingAction = null;
}

function pinInput(digit) {
  if (pinBuffer.length >= 4) return;
  pinBuffer += digit;
  updatePinDots();
  if (pinBuffer.length === 4) {
    setTimeout(checkPin, 150);
  }
}

function pinDelete() {
  pinBuffer = pinBuffer.slice(0, -1);
  updatePinDots();
}

function pinClear() {
  pinBuffer = '';
  updatePinDots();
}

function updatePinDots(error = false) {
  const dots = document.querySelectorAll('.pin-dot');
  dots.forEach((d, i) => {
    d.classList.remove('filled', 'error');
    if (error) d.classList.add('error');
    else if (i < pinBuffer.length) d.classList.add('filled');
  });
}

function checkPin() {
  const { name, punchType } = pinPendingAction;
  const correct = pins[name];
  if (!correct) {
    // PINãŒæœªè¨­å®šã®å ´åˆã¯ãã®ã¾ã¾é€šã™
    closePinModal();
    executePunch(name, punchType);
    return;
  }
  if (pinBuffer === correct) {
    closePinModal();
    executePunch(name, punchType);
  } else {
    updatePinDots(true);
    showToast('âŒ', 'PINãŒé•ã„ã¾ã™');
    setTimeout(() => {
      pinBuffer = '';
      updatePinDots();
    }, 800);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSONAL PAGE (URL param)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let personalUser = null;

function initPersonalPage() {
  const params = new URLSearchParams(window.location.search);
  const user = params.get('user');
  if (!user) return;

  personalUser = decodeURIComponent(user);

  // ãƒãƒŠãƒ¼è¡¨ç¤º
  document.getElementById('personalBanner').style.display = 'block';
  document.getElementById('bannerName').textContent = personalUser;

  // ç®¡ç†ç³»ã‚¿ãƒ–ã‚’éè¡¨ç¤º
  document.getElementById('navEmployees').style.display = 'none';
  document.getElementById('navQr').style.display = 'none';
  // GASè¨­å®šæ¬„ã‚’éè¡¨ç¤ºï¼ˆå¾“æ¥­å“¡ã«ã¯ä¸è¦ï¼‰
  var gasBox = document.getElementById('gasSetupBox');
  if (gasBox) gasBox.style.display = 'none';

  // ãƒ‘ãƒ¼ãƒˆä»¥å¤–ã¯ã‚·ãƒ•ãƒˆç”³è«‹ã‚¿ãƒ–ã‚’éè¡¨ç¤º
  const emp = employees.find(e => e.name === personalUser);
  if (emp && emp.type !== 'ãƒ‘ãƒ¼ãƒˆ') {
    const shiftNav = document.getElementById('navShift');
    if (shiftNav) shiftNav.style.display = 'none';
  }

  // å…¨ã‚»ãƒ¬ã‚¯ãƒˆã«åå‰ã‚’å›ºå®š
  setTimeout(() => {
    ['punchName','leaveName','shiftName'].forEach(id => {
      const sel = document.getElementById(id);
      // é¸æŠè‚¢ã‚’æœ¬äººã®ã¿ã«
      sel.innerHTML = '<option value="'+personalUser+'">'+personalUser+'</option>';
      sel.value = personalUser;
      sel.disabled = true;
      sel.style.opacity = '0.7';
    });
  }, 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QR CODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderQrList() {
  const el = document.getElementById('qrList');
  if (!employees.length) {
    el.innerHTML = '<div style="color:var(--text-sub);font-size:13px;">ç¤¾å“¡ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ç¤¾å“¡ç®¡ç†ã‚¿ãƒ–ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
    return;
  }
  el.innerHTML = employees.map(e => `
    <div class="qr-item" id="qr-item-${e.id}">
      <div class="qr-item-header">
        <div>
          <div class="qr-item-name">${e.name}</div>
          <div class="qr-item-type">${e.type}</div>
        </div>
      </div>
      <div class="qr-canvas-wrap">
        <canvas id="qr-canvas-${e.id}" width="160" height="160"></canvas>
      </div>
      <div class="qr-url" id="qr-url-${e.id}"></div>
      <div class="qr-btns">
        <button class="qr-btn qr-btn-print" onclick="printQr(${e.id},'${e.name}')">ğŸ–¨ å°åˆ·</button>
        <button class="qr-btn qr-btn-copy" onclick="copyUrl(${e.id})">ğŸ“‹ URLã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
  `).join('');

  // QRç”Ÿæˆ
  employees.forEach(e => generateQr(e));
}

function getPersonalUrl(name) {
  const base = window.location.href.split('?')[0];
  return base + '?user=' + encodeURIComponent(name);
}

function generateQr(emp) {
  const url = getPersonalUrl(emp.name);
  document.getElementById('qr-url-'+emp.id).textContent = url;
  const canvas = document.getElementById('qr-canvas-'+emp.id);
  drawQr(canvas, url);
}

// ã‚·ãƒ³ãƒ—ãƒ«ãªQRã‚³ãƒ¼ãƒ‰æç”»ï¼ˆqrcode.jsä½¿ç”¨ï¼‰
function drawQr(canvas, text) {
  // QRã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’CDNã‹ã‚‰èª­ã¿è¾¼ã¿
  if (window.QRCode) {
    renderQrCanvas(canvas, text);
  } else {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
    script.onload = () => renderQrCanvas(canvas, text);
    document.head.appendChild(script);
  }
}

function renderQrCanvas(canvas, text) {
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,160,160);
  try {
    const qr = new QRCode(document.createElement('div'), {
      text, width:160, height:160,
      colorDark:'#000000', colorLight:'#ffffff',
      correctLevel: QRCode.CorrectLevel.M
    });
    setTimeout(() => {
      const img = qr._el.querySelector('img') || qr._el.querySelector('canvas');
      if (img) {
        ctx.drawImage(img, 0, 0, 160, 160);
      }
    }, 100);
  } catch(e) {
    ctx.fillStyle = '#333';
    ctx.font = '12px sans-serif';
    ctx.fillText('QRç”Ÿæˆä¸­...', 40, 80);
  }
}

function printQr(id, name) {
  const url = getPersonalUrl(name);
  const canvas = document.getElementById('qr-canvas-'+id);
  const dataUrl = canvas.toDataURL();
  const win = window.open('','_blank');
  win.document.write(`
    <html><head><title>${name} å‹¤æ€ æ‰“åˆ»QR</title>
    <style>
      body{font-family:sans-serif;text-align:center;padding:40px;}
      img{width:200px;height:200px;}
      h2{font-size:20px;margin-bottom:8px;}
      p{font-size:11px;color:#666;word-break:break-all;max-width:280px;margin:8px auto 0;}
    </style></head>
    <body>
      <h2>${name}</h2>
      <img src="${dataUrl}">
      <p>${url}</p>
      <script>window.onload=()=>window.print()<\/script>
    </body></html>
  `);
  win.document.close();
}

function copyUrl(id) {
  const url = document.getElementById('qr-url-'+id).textContent;
  navigator.clipboard.writeText(url).then(() => {
    showToast('ğŸ“‹','URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  }).catch(() => {
    showToast('âš ï¸','ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
  });
}
let toastTimer;
function showToast(icon, text) {
  const t = document.getElementById('toast');
  document.getElementById('toastIcon').textContent = icon;
  document.getElementById('toastText').textContent = text;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadGasUrl();
refreshSelects();
initCalendar();
initPersonalPage();
// iPadãƒãƒ¼ãƒ ã®QRã‚¿ãƒ–ã‚’éè¡¨ç¤ºï¼ˆåˆæœŸï¼‰
if (!personalUser) {
  // QRã¯å–¶æ¥­ãƒãƒ¼ãƒ ã®ã¿å¯¾è±¡ãªã®ã§ãã®ã¾ã¾è¡¨ç¤º
}
</script>
</body>
</html>
